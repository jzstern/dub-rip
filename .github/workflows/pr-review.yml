name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize review
        run: |
          mkdir -p /tmp/review
          echo "" > /tmp/review/errors.md
          echo "" > /tmp/review/warnings.md
          echo "" > /tmp/review/suggestions.md

      - name: Get changed files count
        id: changed-files
        run: |
          COUNT=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -c . || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Run security checks
        run: |
          echo "## Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SENSITIVE_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(env|pem|key)$' || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "::error::Sensitive files detected in PR"
            echo "- :x: Sensitive files detected" >> $GITHUB_STEP_SUMMARY
            SENSITIVE_LIST=$(echo "$SENSITIVE_FILES" | tr '\n' ',' | sed 's/,$//')
            echo "- **Sensitive files committed**: \`$SENSITIVE_LIST\` - these should never be in version control" >> /tmp/review/errors.md
          else
            echo "- :white_check_mark: No sensitive files" >> $GITHUB_STEP_SUMMARY
          fi

          SENSITIVE_LOGS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E 'console\.(log|debug|info).*\b(password|token|secret|key|api)\b' || true)
          if [ -n "$SENSITIVE_LOGS" ]; then
            echo "::warning::Potential sensitive data in logs"
            echo "- :warning: Potential sensitive data logging detected" >> $GITHUB_STEP_SUMMARY
            echo "- **Potential sensitive data in logs**: Found console statements that may log credentials or secrets" >> /tmp/review/warnings.md
          else
            echo "- :white_check_mark: No sensitive data logging detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check code style
        run: |
          echo "## Code Style" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CHANGED_TS_SVELTE=$(git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -E '\.(ts|svelte)$' || true)
          if [ -n "$CHANGED_TS_SVELTE" ]; then
            SPACE_INDENT=""
            echo "$CHANGED_TS_SVELTE" | while IFS= read -r file; do
              if [ -f "$file" ] && grep -q "^  [^ ]" "$file" 2>/dev/null; then
                echo "$file" >> /tmp/review/space_indent.txt
              fi
            done
            if [ -f /tmp/review/space_indent.txt ]; then
              SPACE_INDENT=$(tr '\n' ',' < /tmp/review/space_indent.txt | sed 's/,$//')
            fi

            if [ -n "$SPACE_INDENT" ]; then
              echo "::warning::Files with space indentation (should use tabs):$SPACE_INDENT"
              echo "- :warning: Space indentation detected (should use tabs)" >> $GITHUB_STEP_SUMMARY
              echo "- **Inconsistent indentation**: Use tabs instead of spaces in:\`$SPACE_INDENT\`" >> /tmp/review/suggestions.md
            else
              echo "- :white_check_mark: Correct tab indentation" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- :white_check_mark: No TypeScript/Svelte files changed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for TODO/FIXME comments
        run: |
          TODO_LINES=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E '^\+.*\b(TODO|FIXME|HACK|XXX)\b' || true)
          if [ -n "$TODO_LINES" ]; then
            echo "- **New TODO/FIXME comments added**: Consider resolving these before merging or creating tracking issues" >> /tmp/review/suggestions.md
          fi

      - name: Check for large files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD | while IFS= read -r file; do
            if [ -f "$file" ]; then
              SIZE=$(wc -c < "$file" 2>/dev/null || echo "0")
              if [ "$SIZE" -gt 500000 ]; then
                echo "$file ($(numfmt --to=iec $SIZE 2>/dev/null || echo "${SIZE}B"))" >> /tmp/review/large_files.txt
              fi
            fi
          done
          if [ -f /tmp/review/large_files.txt ]; then
            LARGE_FILES=$(tr '\n' ',' < /tmp/review/large_files.txt | sed 's/,$//')
            echo "- **Large files detected**: $LARGE_FILES - consider if these need to be in the repo" >> /tmp/review/warnings.md
          fi

      - name: PR Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Post PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERRORS=$(cat /tmp/review/errors.md | grep -v '^$' || true)
          WARNINGS=$(cat /tmp/review/warnings.md | grep -v '^$' || true)
          SUGGESTIONS=$(cat /tmp/review/suggestions.md | grep -v '^$' || true)

          COMMENT_FILE=/tmp/review/comment.md
          echo "## ðŸ” Automated PR Review" > "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"

          HAS_ISSUES=false

          if [ -n "$ERRORS" ]; then
            HAS_ISSUES=true
            echo "### âŒ Issues (must fix)" >> "$COMMENT_FILE"
            echo "" >> "$COMMENT_FILE"
            echo "$ERRORS" >> "$COMMENT_FILE"
            echo "" >> "$COMMENT_FILE"
          fi

          if [ -n "$WARNINGS" ]; then
            HAS_ISSUES=true
            echo "### âš ï¸ Warnings" >> "$COMMENT_FILE"
            echo "" >> "$COMMENT_FILE"
            echo "$WARNINGS" >> "$COMMENT_FILE"
            echo "" >> "$COMMENT_FILE"
          fi

          if [ -n "$SUGGESTIONS" ]; then
            HAS_ISSUES=true
            echo "### ðŸ’¡ Suggestions" >> "$COMMENT_FILE"
            echo "" >> "$COMMENT_FILE"
            echo "$SUGGESTIONS" >> "$COMMENT_FILE"
            echo "" >> "$COMMENT_FILE"
          fi

          if [ "$HAS_ISSUES" = false ]; then
            FILE_COUNT="${{ steps.changed-files.outputs.count }}"
            cat >> "$COMMENT_FILE" << 'SUCCESSEOF'
âœ… **No issues found**

This PR passes all automated checks:
- No sensitive files or credentials detected
- No sensitive data logging
- Code style follows project conventions
- No new TODO/FIXME comments added
- No oversized files

SUCCESSEOF
            echo "_${FILE_COUNT} file(s) reviewed_" >> "$COMMENT_FILE"
          else
            echo "---" >> "$COMMENT_FILE"
            echo "_Please address the issues above before merging._" >> "$COMMENT_FILE"
          fi

          EXISTING_COMMENT=$(gh api --paginate "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" --jq '.[] | select(.user.login == "github-actions[bot]") | select(.body | contains("Automated PR Review")) | .id' | head -1 || true)

          if [ -n "$EXISTING_COMMENT" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT" -X PATCH -F body=@"$COMMENT_FILE"
          else
            gh pr comment ${{ github.event.pull_request.number }} --body-file "$COMMENT_FILE"
          fi
